<style>
  #add-color {
    --border-width: 1px;
    --margin-horizontal: 1lh;
    background: lightgray;
    border: var(--border-width) solid darkgray;
    margin: 0.5lh var(--margin-horizontal);
    padding: 0;
    width: calc(100% - 2 * var(--border-width) - 2 * var(--margin-horizontal));
  }

  #colors {
    list-style: none;
    margin: 0.5lh 1lh;
    padding: 0;
  }

  #colors .color {
    --color-padding-horizontal: 0;
    --color-padding-vertical: 0.2lh;
    padding: var(--color-padding-vertical) var(--color-padding-horizontal);
  }

  #colors .definition {
    color: gray;
    font-family: monospace;
    font-size: smaller;
  }

  #colors .delete,
  #colors .edit {
    border: 0;
    padding: 0;
  }

  #colors .swatch {
    display: inline-block;
    height: 1lh;
    margin-bottom: calc(0 - var(--color-padding-vertical));
    margin-top: calc(0 - var(--color-padding-vertical));
  }

  #colors .swatch-primary {
    margin-left: calc(0 - var(--color-padding-horizontal));
    width: 2lh;
  }

  button {
    appearance: none;
    font-family: inherit;
    font-size: inherit;
  }
</style>

<script type="module">
  /**
   * @typedef ColorData
   * @property {string} definition
   * @property {string} name
   */

  /** @type {HTMLButtonElement} */
  let addColorButton = null;

  /** @type {HTMLElement} */
  let colorList = null;

  /** @type {HTMLTemplateElement} */
  let colorTemplate = null;

  function addColor(/** @type {ColorData} */ { name, definition }) {
    /** @type {HTMLElement} */
    const color = colorTemplate.content.firstElementChild.cloneNode(true);

    color.dataset.definition = definition;
    color.dataset.name = name;
    color.querySelector(".definition").textContent = definition;

    const nameElement = color.querySelector(".name");

    nameElement.textContent = name;
    nameElement.addEventListener("blur", updateName.bind(null, color));

    color
      .querySelector(".swatch-primary")
      .setAttribute("style", "background-color:" + definition);

    color
      .querySelector(".delete")
      .addEventListener("click", deleteColor.bind(null, color));

    colorList.append(color);
  }

  // function addUniversalEventListener(
  //   /** @type {HTMLElement} */ element,
  //   /** @type {(event: Event) => void} */ handler,
  // ) {
  //   const seen = new Set();

  //   for (let key in element) {
  //     if (key.startsWith("on")) {
  //       element.addEventListener(key.slice(2).toLowerCase(), (event) => {
  //         if (!seen.has(event.type)) {
  //           seen.add(event.type);
  //           handler(event);
  //         }
  //       });
  //     }
  //   }
  // }

  function deleteColor(/** @type {HTMLElement} */ color) {
    color.remove();

    saveColors();
  }

  function normalizeName(/** @type {string} */ name) {
    return (
      name
        ?.toLowerCase()
        .replace(/'/g, "")
        .replace(/[^a-z]+/g, "-")
        .replace(/^-?/, "--")
        .replace(/-$/, "") ?? "--unknown"
    );
  }

  function onContentLoaded() {
    if (!addColorButton || addColorButton.ownerDocument !== document) {
      addColorButton = document.getElementById("add-color");

      addColorButton.addEventListener("click", () => {
        addColor({ name: "--new-color", definition: "#7f7f7f" });
        saveColors();
      });
    }

    if (!colorList || colorList.ownerDocument !== document) {
      colorList = document.getElementById("colors");
    }

    if (!colorTemplate || colorTemplate.ownerDocument !== document) {
      colorTemplate = document.getElementById("new-color");
    }

    // Load colors.
    JSON.parse(localStorage.getItem("colors") ?? "[]").forEach(addColor);
  }

  function saveColors() {
    /** @type {Array<ColorData>} */
    const colors = [];

    for (const color of colorList.children) {
      const { definition, name } = color.dataset;

      colors.push({ definition, name });
    }

    localStorage.setItem("colors", JSON.stringify(colors));
  }

  function updateName(/** @type {HTMLElement} */ color) {
    const nameElement = color.querySelector(".name");
    const name = normalizeName(nameElement.textContent);

    nameElement.textContent = name;
    color.dataset.name = name;

    saveColors();
  }

  document.addEventListener("DOMContentLoaded", onContentLoaded);

  // Hot reloading doesn't re-trigger DOMContentLoaded.
  window.setInterval(() => {
    if (!colorList || colorList.children.length === 0) {
      onContentLoaded();
    }
  }, 1000);
</script>

<ul id="colors"></ul>

<button id="add-color">+</button>

<template id="new-color">
  <li class="color">
    <span class="swatch swatch-primary">&nbsp;</span>
    <span class="name" contenteditable></span>
    <span class="definition"></span>
    <button class="edit">‚úè</button>
    <button class="delete">üóë</button>
  </li>
</template>
